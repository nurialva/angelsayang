<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Angel's Planner</title>
    <link rel="manifest" href="manifest.json">
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <style>
        :root { 
            --pink-main: #ff85a2; 
            --pink-light: #ffb3c1; 
            --pink-bg: #fff0f3; 
            --text-dark: #5c2d36; 
            --header-h: 70px;
            --nav-h: 75px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html, body { 
            height: 100%; margin: 0; padding: 0; 
            overflow: hidden; background: var(--pink-bg);
            font-family: 'Nunito', sans-serif;
        }

        .app-shell {
            display: flex; flex-direction: column;
            height: 100vh; max-width: 500px; margin: 0 auto;
            position: relative; background: var(--pink-bg);
        }

        header {
            height: var(--header-h);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; background: var(--pink-bg); z-index: 100;
        }
        header h1 { margin: 0; color: var(--pink-main); font-size: 24px; font-weight: 700; }

        main {
            flex: 1; overflow-y: auto; padding: 10px 20px;
            -webkit-overflow-scrolling: touch;
        }

        nav {
            height: var(--nav-h); background: white;
            display: flex; justify-content: space-around; align-items: center;
            border-top-left-radius: 30px; border-top-right-radius: 30px;
            box-shadow: 0 -8px 20px rgba(255, 133, 162, 0.1);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item { 
            color: var(--pink-light); text-decoration: none; 
            display: flex; flex-direction: column; align-items: center; transition: 0.3s;
        }
        .nav-item.active { color: var(--pink-main); transform: translateY(-3px); }
        .nav-item .material-icons-round { font-size: 28px; }

        /* UI Card */
        .card { 
            background: #fff; padding: 18px; margin-bottom: 12px; border-radius: 20px; 
            display: flex; align-items: center; gap: 15px; 
            box-shadow: 0 4px 15px rgba(255, 133, 162, 0.08); 
        }
        .card.checked { opacity: 0.5; background: #fafafa; }
        .card-content { flex: 1; }
        .card-content strong { display: block; font-size: 16px; color: var(--text-dark); }
        .card-content small { color: #999; font-size: 12px; }

        /* Day Selector Styles */
        .day-selector {
            display: flex; justify-content: space-between; margin: 15px 0;
        }
        .day-checkbox { display: none; }
        .day-label {
            width: 38px; height: 38px; border-radius: 50%;
            border: 2px solid var(--pink-light);
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: bold; color: var(--pink-light);
            cursor: pointer; transition: 0.3s;
        }
        .day-checkbox:checked + .day-label {
            background: var(--pink-main); color: white; border-color: var(--pink-main);
        }

        /* Forms */
        input[type="text"], textarea { 
            width: 100%; padding: 14px; margin: 8px 0; 
            border: 2px solid var(--pink-light); border-radius: 12px; 
            outline: none; font-size: 16px; font-family: inherit;
        }
        .btn { 
            background: var(--pink-main); color: white; border: none; padding: 16px; 
            border-radius: 15px; font-weight: 700; width: 100%; font-size: 16px; cursor: pointer;
        }
        
        .section-label { font-weight: bold; font-size: 14px; color: var(--pink-main); margin-top: 10px; display: block; }

        #view-login { position: fixed; inset: 0; background: var(--pink-bg); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="app-shell">
    
    <div id="view-login" class="hidden">
        <div style="background:white; padding:40px 30px; border-radius:30px; width:88%; text-align:center;">
            <span class="material-icons-round" style="font-size: 64px; color: var(--pink-main)">favorite</span>
            <h2 style="margin: 15px 0;">Angel's App</h2>
            <form id="form-login">
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-pass" placeholder="Password" required>
                <button type="submit" class="btn" style="margin-top:10px;">Masuk</button>
            </form>
        </div>
    </div>

    <header id="app-header">
        <h1 id="page-title">Hari Ini</h1>
        <span class="material-icons-round" id="logout-btn" style="color:var(--pink-main); cursor:pointer;">logout</span>
    </header>

    <main id="app-main">
        <div id="view-home" class="page-content hidden">
            <div id="today-list"></div>
        </div>

        <div id="view-missed" class="page-content hidden">
            <div id="missed-list"></div>
        </div>

        <div id="view-create" class="page-content hidden">
            <div class="card" style="display:block">
                <h3 style="margin:0 0 15px 0; color: var(--pink-main)">Rencana Baru</h3>
                <form id="form-add">
                    <span class="section-label">Judul Aktivitas</span>
                    <input type="text" id="title" placeholder="Misal: Minum Vitamin" required>
                    
                    <span class="section-label">Catatan (Opsional)</span>
                    <textarea id="desc" rows="2" placeholder="Jangan lupa ya sayang..."></textarea>
                    
                    <span class="section-label">Ulangi di Hari:</span>
                    <div class="day-selector">
                        <input type="checkbox" id="d1" class="day-checkbox" value="1"><label for="d1" class="day-label">Sen</label>
                        <input type="checkbox" id="d2" class="day-checkbox" value="2"><label for="d2" class="day-label">Sel</label>
                        <input type="checkbox" id="d3" class="day-checkbox" value="3"><label for="d3" class="day-label">Rab</label>
                        <input type="checkbox" id="d4" class="day-checkbox" value="4"><label for="d4" class="day-label">Kam</label>
                        <input type="checkbox" id="d5" class="day-checkbox" value="5"><label for="d5" class="day-label">Jum</label>
                        <input type="checkbox" id="d6" class="day-checkbox" value="6"><label for="d6" class="day-label">Sab</label>
                        <input type="checkbox" id="d0" class="day-checkbox" value="0"><label for="d0" class="day-label">Min</label>
                    </div>
                    
                    <button type="submit" class="btn" style="margin-top:10px;">Simpan Rencana</button>
                </form>
            </div>
        </div>
    </main>

    <nav id="app-nav">
        <a href="#home" class="nav-item" id="nav-home">
            <span class="material-icons-round">home</span>
            <span style="font-size:10px; font-weight:700;">Home</span>
        </a>
        <a href="#missed" class="nav-item" id="nav-missed">
            <span class="material-icons-round">history</span>
            <span style="font-size:10px; font-weight:700;">Lupa</span>
        </a>
        <a href="#create" class="nav-item" id="nav-create">
            <span class="material-icons-round">add_circle</span>
            <span style="font-size:10px; font-weight:700;">Tambah</span>
        </a>
    </nav>
</div>

<script>
    const API_BASE = "https://apis.geekpesantren.web.id/Api_Angel";

    function checkAuth() {
        if (!localStorage.getItem('angel_auth')) {
            $('#view-login').removeClass('hidden');
            $('#app-header, #app-main, #app-nav').addClass('hidden');
        } else {
            $('#view-login').addClass('hidden');
            $('#app-header, #app-main, #app-nav').removeClass('hidden');
            navigate();
        }
    }

    function navigate() {
        let hash = window.location.hash || '#home';
        $('.page-content').addClass('hidden');
        $('.nav-item').removeClass('active');
        $(`#view-${hash.replace('#','')}`).removeClass('hidden');
        $(`#nav-${hash.replace('#','')}`).addClass('active');

        if(hash === '#home') { $('#page-title').text('Hari Ini'); loadToday(); }
        if(hash === '#missed') { $('#page-title').text('Lupa Ceklis'); loadMissed(); }
        if(hash === '#create') { $('#page-title').text('Buat Baru'); }
    }

    function loadToday() {
        $.getJSON(`${API_BASE}/list_today`, d => {
            let h = '';
            d.forEach(t => {
                h += `<div class="card ${t.log_id?'checked':''}">
                    <input type="checkbox" ${t.log_id?'checked':''} onchange="toggleTask(${t.id})" style="width:25px; height:25px; accent-color:var(--pink-main);">
                    <div class="card-content">
                        <strong>${t.title}</strong>
                        <small>${t.description || ''}</small>
                    </div>
                </div>`;
            });
            $('#today-list').html(h || '<p style="text-align:center; opacity:0.5; margin-top:50px;">Tidak ada jadwal hari ini</p>');
        });
    }

    function loadMissed() {
        $.getJSON(`${API_BASE}/list_missed`, d => {
            let h = '';
            if(d.length === 0) h = '<p style="text-align:center; opacity:0.5; margin-top:50px;">Semua tuntas kemarin!</p>';
            d.forEach(t => h += `<div class="card" style="border-left:5px solid orange"><strong>${t.title}</strong></div>`);
            $('#missed-list').html(h);
        });
    }

    function toggleTask(id) { $.post(`${API_BASE}/toggle_check`, {activity_id:id}, () => loadToday()); }

    $('#form-add').submit(function(e){
        e.preventDefault();
        
        // Ambil hari-hari yang diceklis
        let selectedDays = [];
        $('.day-checkbox:checked').each(function(){
            selectedDays.push($(this).val());
        });

        const data = {
            title: $('#title').val(),
            description: $('#desc').val(),
            // Jika pilih hari, kirim array hari sebagai string (misal: "1,2,3")
            // Backend CI3 kamu harus menghandle ini di field repeating_days (atau sejenisnya)
            days: selectedDays.join(',') 
        };

        $.post(`${API_BASE}/add_activity`, data, () => {
            window.location.hash = '#home';
            $('#form-add')[0].reset();
            $('.day-checkbox').prop('checked', false);
        });
    });

    $('#form-login').submit(function(e){
        e.preventDefault();
        $.post(`${API_BASE}/login`, {email:$('#login-email').val(), password:$('#login-pass').val()}, () => {
            localStorage.setItem('angel_auth', 'true'); checkAuth();
        }).fail(() => alert('Password salah!'));
    });

    $('#logout-btn').click(() => { if(confirm('Logout?')){ localStorage.removeItem('angel_auth'); checkAuth(); }});

    window.onhashchange = navigate;
    $(document).ready(checkAuth);
</script>
</body>
</html>
